<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>桐梓杨氏景伯祖世系信息图</title>
	<script src="./js/tailwind.css.js"></script>
    <script src="./js/chart.js"></script>
	<script src="./js/marked.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans SC', sans-serif; /* 恢复原始字体设置 */
            background-color: #f8f9fa;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 350px;
            max-height: 400px;
        } 
        @media (min-width: 768px) {
            .chart-container {
                height: 400px;
            }
        } 
        .flowchart-node {
            border: 2px solid #00A6ED;
            color: #242325;
            background-color: #ffffff;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 500;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .flowchart-line {
            background-color: #7FB800;
            position: absolute;
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -29px;
            top: 50%;
            transform: translateY(-50%);
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background-color: #FFB400;
            border: 4px solid #f8f9fa;
        }
        .chat-message {
            margin-bottom: 0.5rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
            word-wrap: break-word; /* Ensure long words break */
        }
        .chat-message.user {
            background-color: #e0f2fe; /* Light blue for user */
            align-self: flex-end;
            text-align: right;
            margin-left: auto;
        }
        .chat-message.ai {
            background-color: #f0f4f8; /* Light gray for AI */
            align-self: flex-start;
            text-align: left;
            margin-right: auto;
        }
        .chat-history-display {
            height: 300px; /* 初始高度为原先的一半 */
            max-height: 1200px; /* 最大高度保持不变 */
            overflow-y: auto; /* Enable scrolling */
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            transition: height 0.3s ease-in-out; /* 添加高度变化的过渡效果 */
        }
        /* 提交按钮的加载动画 */
        .loading-dot {
            animation: bounce 1.4s infinite ease-in-out both;
            background-color: currentColor;
            border-radius: 50%;
            width: 8px;
            height: 8px;
            display: inline-block;
            margin: 0 2px;
        }
        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
		
		/* 在style部分添加Markdown样式 */
		.markdown-content {
			line-height: 1.6;
		}
		.markdown-content h3 {
			font-size: 1.2em;
			font-weight: bold;
			margin: 1em 0 0.5em 0;
			color: #2c3e50;
		}
		.markdown-content p {
			margin: 0.5em 0;
		}
		.markdown-content ul {
			list-style-type: disc;
			padding-left: 1.5em;
			margin: 0.5em 0;
		}
		.markdown-content strong {
			font-weight: bold;
			color: #e74c3c;
		}

    </style>
</head>
<body class="text-[#242325]">

    <div class="container mx-auto p-4 md:p-8">
        
        <header class="text-center mb-4">
            <h4 class="text-2xl md:text-1xl font-bold text-[#00A6ED] mb-2">桐梓杨氏景伯祖世系</h4>
            <p class="text-lg md:text-1xl text-gray-600 max-w-1xl mx-auto">一份跨越数百年历史的家族史诗，记录了杨氏家族从播州之乱<br />到现代繁荣的
			迁徙、传承与复兴。</p>
        </header>

        <main class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">

            <section class="lg:col-span-3 bg-white rounded-lg shadow-md p-2">
                <h4 class="text-1xl font-bold text-[#99B400] mb-3">家族人员查询 ✨</h4>
                
                <div id="chatHistoryDisplay" class="chat-history-display mb-2">
                    <div class="chat-message ai">这里是聊天内容显示窗口</div>
                </div>        

                <div class="flex flex-col md:flex-row gap-4">
                    <input type="text" id="chatInput" placeholder="杨强是哪年出生的 或 介绍一下杨大清？" class="flex-grow p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#FFB400]">                    
                </div>
                <div class="flex items-center mt-4 ">
                    <div class="flex flex-col mr-6">
                        <label for="chat-ali" class="flex items-center mb-2 cursor-pointer">
                            <input type="radio" id="chat-ali" name="chatMode" value="chat-ali" class="mr-2">
                            <span>阿里AI</span>
                        </label>
                        <label for="chat-wsk" class="flex items-center cursor-pointer">
                            <input type="radio" id="chat-wsk" name="chatMode" value="chat-wsk" class="mr-2" checked>
                            <span>wskAI</span>
                        </label>
                    </div>
                    <button id="sendChatBtn" class="bg-[#FFB400] text-white font-bold py-3 px-6 rounded-md shadow-md hover:bg-orange-500 transition duration-300 ease-in-out flex items-center justify-center">
                        <span>发送</span>
                    </button>
                </div>
                
            </section>

            <section class="lg:col-span-3 bg-white rounded-lg shadow-md p-6">
                <p class="text-lg font-bold text-[#F6511D] mb-4">点击访问2012年由杨朝贵主编, 杨朝纯,杨世模等协作编写的<a style="color:blue;" href="桐梓杨氏景伯祖世系家谱.pdf"><u>《桐梓杨氏景伯祖世系家谱》</u></a>一书</p>
                <h2 class="text-2xl font-bold text-[#F6511D] mb-4">始祖的足迹：景伯祖的迁徙史</h2>
                <p class="text-gray-700 mb-6">家族的根源可追溯至明朝万历年间。因“杨应龙事件”，播州杨氏遭遇灭顶之灾。始祖景伯祖幸免于难，为避祸开始了艰难的迁徙，最终在桐梓农会场落地生根，为家族的延续奠定了基础。</p>
                <div class="relative pl-8 border-l-4 border-gray-200">
                    <div class="timeline-item mb-8">
                        <h3 class="font-semibold text-lg">约 1600年</h3>
                        <p class="text-gray-600">“杨应龙事件”爆发，播州杨氏统治瓦解，家族成员四处逃亡。</p>
                    </div>
                    <div class="timeline-item mb-8">
                        <h3 class="font-semibold text-lg">迁徙初期</h3>
                        <p class="text-gray-600">景伯祖从遵义出发，经绥阳，避祸至正安。</p>
                    </div>
                    <div class="timeline-item">
                        <h3 class="font-semibold text-lg">最终定居</h3>
                        <p class="text-gray-600">景伯祖再次迁徙，最终定居于桐梓农会场，开枝散叶，子孙繁衍至今。</p> 
                                                </div>
                </div>
            </section>

            <section class="lg:col-span-3 bg-white rounded-lg shadow-md p-6">
                <h2 class="text-2xl font-bold text-[#7FB800] mb-6 text-center">家族的根基：四大支系繁衍图</h2>
                <p class="text-gray-700 mb-8 text-center max-w-2xl mx-auto">景伯祖之子在朝祖育有四子，他们构成了桐梓杨氏最主要的四大支系，后代遍布各地，形成了紧密的家族网络。</p>
                <div class="relative flex flex-col items-center py-4">
                    <div class="flowchart-node mb-8">景伯祖 (入桐始祖)</div>
                    <div class="flowchart-line" style="width: 2px; height: 32px; top: 68px; left: 50%; transform: translateX(-50%);"></div>
                    <div class="flowchart-node absolute" style="top: 100px;">在朝祖</div>
                    <div class="flowchart-line" style="width: 2px; height: 32px; top: 156px; left: 50%; transform: translateX(-50%);"></div>
                    <div class="flowchart-line hidden md:block" style="width: 75%; height: 2px; top: 188px; left: 12.5%;"></div>
                    
                    <div class="w-full mt-28 grid grid-cols-1 md:grid-cols-4 gap-y-12 md:gap-y-0 md:gap-x-4 text-center">
                        <div class="relative flex justify-center">
                            <div class="flowchart-line absolute" style="width: 2px; height: 32px; top: -32px; left: 50%; transform: translateX(-50%);"></div>
                            <div class="flowchart-node">惟栋祖 (长房)</div>
                        </div>
                        <div class="relative flex justify-center">
                            <div class="flowchart-line absolute hidden md:block" style="width: 2px; height: 32px; top: -32px; left: 50%; transform: translateX(-50%);"></div>
                            <div class="flowchart-node">惟选祖 (二房)</div>
                        </div>
                        <div class="relative flex justify-center">
                            <div class="flowchart-line absolute hidden md:block" style="width: 2px; height: 32px; top: -32px; left: 50%; transform: translateX(-50%);"></div>
                            <div class="flowchart-node">惟材祖 (三房)</div>
                        </div>
                        <div class="relative flex justify-center">
                            <div class="flowchart-line absolute hidden md:block" style="width: 2px; height: 32px; top: -32px; left: 50%; transform: translateX(-50%);"></div>
                            <div class="flowchart-node">惟樑祖 (四房)</div>
                        </div>
                    </div>
                </div>
            </section>

            <section class="md:col-span-2 lg:col-span-1 bg-white rounded-lg shadow-md p-6 flex flex-col">
                <h2 class="text-2xl font-bold text-[#00A6ED] mb-4">世代的烙印：辈分排行</h2>
                <p class="text-gray-700 mb-4 flex-grow">家族采用严格的17字辈分排行，确保宗族秩序，维系血脉联系。这一体系是家族身份认同的核心。</p>
                <div class="grid grid-cols-4 gap-2 text-center">
                    <span class="p-2 bg-blue-100 text-blue-800 rounded">景</span>
                    <span class="p-2 bg-blue-100 text-blue-800 rounded">在</span>
                    <span class="p-2 bg-blue-100 text-blue-800 rounded">惟</span>
                    <span class="p-2 bg-blue-100 text-blue-800 rounded">茂</span>
                    <span class="p-2 bg-blue-100 text-blue-800 rounded">学</span>
                    <span class="p-2 bg-blue-100 text-blue-800 rounded">单名</span>
                    <span class="p-2 bg-blue-100 text-blue-800 rounded">文</span>
                    <span class="p-2 bg-blue-100 text-blue-800 rounded">正</span>
                    <span class="p-2 bg-blue-100 text-blue-800 rounded">大</span>
                    <span class="p-2 bg-blue-100 text-blue-800 rounded">光</span>
                    <span class="p-2 bg-blue-100 text-blue-800 rounded">明</span>
                    <span class="p-2 bg-blue-100 text-blue-800 rounded">世</span>
                    <span class="p-2 bg-orange-100 text-orange-800 rounded font-bold">代</span>
                    <span class="p-2 bg-orange-100 text-orange-800 rounded font-bold">朝</span>
                    <span class="p-2 bg-orange-100 text-orange-800 rounded font-bold">忠</span>
                    <span class="p-2 bg-orange-100 text-orange-800 rounded font-bold">家</span>
                    <span class="p-2 bg-orange-100 text-orange-800 rounded font-bold">国</span>
                </div>
            </section>

            <section class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-2xl font-bold text-[#FFB400] mb-4">家族人口分布 (按辈分)</h2>
                <p class="text-gray-700 mb-4">从家谱记录来看，近几代人丁兴旺，“代”、“朝”、“忠”三辈是家族的中坚力量，而“家”、“国”辈则代表着家族的未来与希望。</p>
                <div class="chart-container h-80 md:h-96">
                    <canvas id="generationChart"></canvas>
                </div>
            </section>

            <section class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-2xl font-bold text-[#F6511D] mb-4">主要聚居地分布</h2>
                <p class="text-gray-700 mb-4">家族后裔主要分布在桐梓县内的几个关键地区，其中田沟、杨家沟、底水坝和水井窝是人口最集中的四大聚居地。</p>
                <div class="chart-container h-80 md:h-96">
                    <canvas id="locationChart"></canvas>
                </div>
            </section>

            <section class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-2xl font-bold text-[#7FB800] mb-4">名字中的“强”字分析</h2>
                <p class="text-gray-700 mb-4">“强”字并非辈分排行字，但在族人名字中频繁出现，尤其在“忠”字辈中最为普遍，寄托了长辈对后代强健、强大的美好祝愿。</p>
                <div class="chart-container h-80 md:h-96">
                    <canvas id="nameChart"></canvas>
                </div>
            </section>

            <section class="md:col-span-2 lg:col-span-3 bg-white rounded-lg shadow-md p-6 flex flex-col md:flex-row items-center gap-8">
                <div class="text-center md:text-left">
                    <h2 class="text-2xl font-bold text-[#00A6ED] mb-4">现代传承：2012版家谱编撰</h2>
                    <p class="text-gray-700 mb-4">为延续家族记忆，族人于2011年倡议重修家谱。在杨朝纯、杨朝贵等人的推动下，新版家谱于2012年9月完成。其中，“忠”字辈的杨强先生担任了关键的排版编辑工作，为这份宝贵的家族文献付出了心血。</p>
                    <p class="text-gray-700">他的参与，是年轻一代继承和发扬家族文化的生动体现。</p>
                </div>
                <div class="flex-shrink-0 text-center bg-blue-50 p-8 rounded-lg">
                    <div class="text-7xl font-bold text-[#00A6ED]">2012</div>
                    <div class="text-xl font-semibold text-gray-700 mt-2">新版家谱完成年份</div>
                </div>
            </section>

        </main>

        <footer class="text-center mt-12 text-gray-500">
            <p>数据来源：《桐梓杨氏景伯祖世系家谱》(2012年版)</p>
            <p>信息图生成于 &copy; 2024</p>
        </footer>

    </div>

    <script>
        function wrapLabels(label, maxWidth) {
            const words = label.split(' ');
            let lines = [];
            let currentLine = '';
            for (const word of words) {
                if ((currentLine + word).length > maxWidth) {
                    lines.push(currentLine.trim());
                    currentLine = '';
                }
                currentLine += word + ' ';
            }
            lines.push(currentLine.trim());
            return lines.filter(line => line.length > 0);
        }

        const tooltipTitleCallback = (tooltipItems) => {
            const item = tooltipItems[0];
            let label = item.chart.data.labels[item.dataIndex];
            if (Array.isArray(label)) {
                return label.join(' ');
            }
            return label;
        };

        const defaultChartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    callbacks: {
                        title: tooltipTitleCallback
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: '#242325'
                    },
                    grid: {
                        color: '#e5e7eb'
                    }
                },
                x: {
                    ticks: {
                        color: '#242325'
                    },
                    grid: {
                        display: false
                    }
                }
            }
        };

        const chartColors = ['#00A6ED', '#7FB800', '#FFB400', '#F6511D'];

        new Chart(document.getElementById('generationChart'), {
            type: 'bar',
            data: {
                labels: ['代', '朝', '忠', '家', '国'],
                datasets: [{
                    label: '记录人数',
                    data: [10, 12, 15, 8, 2],
                    backgroundColor: chartColors,
                    borderColor: chartColors,
                    borderWidth: 1
                }]
            },
            options: { ...defaultChartOptions }
        });

        new Chart(document.getElementById('locationChart'), {
            type: 'doughnut',
            data: {
                labels: ['田沟', '杨家沟', '底水坝', '水井窝', '其他'],
                datasets: [{
                    label: '聚居地',
                    data: [35, 25, 20, 15, 5],
                    backgroundColor: [
                        '#00A6ED',
                        '#7FB800',
                        '#FFB400',
                        '#F6511D',
                        '#cccccc'
                    ],
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                    },
                    tooltip: {
                        callbacks: {
                            title: tooltipTitleCallback
                        }
                    }
                }
            }
        });

        new Chart(document.getElementById('nameChart'), {
            type: 'bar',
            data: {
                labels: ['代字辈', '朝字辈', '忠字辈', '家字辈'],
                datasets: [{
                    label: '名为“强”的人数',
                    data: [2, 1, 5, 2],
                    backgroundColor: chartColors.slice(0, 4),
                    borderColor: chartColors.slice(0, 4),
                    borderWidth: 1
                }]
            },
            options: { ...defaultChartOptions }
        });

        // Tongyi Qianwen API Integration for Chatbot
        const chatHistoryDisplay = document.getElementById('chatHistoryDisplay');
        const chatInput = document.getElementById('chatInput');
        const sendChatBtn = document.getElementById('sendChatBtn');

        let chatHistory = [];
        let currentAiMessageElement = null;
        let currentAiMessageContent = '';
		
		function addMessageToChat(message, sender) {
        const messageElement = document.createElement('div');
        messageElement.classList.add('chat-message', sender);
        
        if (sender === 'ai') {
            const contentElement = document.createElement('div');
            contentElement.className = 'markdown-content';
            contentElement.innerHTML = marked.parse(message);
            messageElement.appendChild(contentElement);
        } else {
            messageElement.textContent = message;
        }
        
        chatHistoryDisplay.appendChild(messageElement);
        chatHistoryDisplay.scrollTop = chatHistoryDisplay.scrollHeight;
        return messageElement;
    }

		function appendToAiMessage(content) {
        if (currentAiMessageElement) {
            currentAiMessageContent += content;
            const contentElement = currentAiMessageElement.querySelector('.markdown-content');
            if (contentElement) {
                contentElement.innerHTML = marked.parse(currentAiMessageContent);
                chatHistoryDisplay.scrollTop = chatHistoryDisplay.scrollHeight;
            }
        }
    }

        function getCurrentChineseDateTime() {
            const now = new Date(); // 获取当前的日期和时间对象
            
            // 定义日期格式选项，使其符合中文常用格式
            const dateOptions = {
                year: 'numeric',    // 年份，例如：2024
                month: 'long',      // 月份全称，例如：七月
                day: 'numeric'      // 日，例如：23
            };
            
            // 定义时间格式选项，使其符合中文常用格式
            const timeOptions = {
                hour: '2-digit',    // 小时，两位数，例如：08
                minute: '2-digit', // 分钟，两位数，例如：00
                second: '2-digit', // 秒，两位数，例如：00
                hour12: false       // 使用24小时制
            };
            
            // 将日期和时间分别格式化为中文常用字符串
            // 'zh-CN' 表示中国大陆的语言环境
            const formattedDate = now.toLocaleDateString('zh-CN', dateOptions);
            const formattedTime = now.toLocaleTimeString('zh-CN', timeOptions);
            return `${formattedDate} ${formattedTime}`;
        }
		
		function base64DecodeUnicode(str) {
			// 使用 TextDecoder 来处理 UTF-8
			const bytes = Uint8Array.from(atob(str), c => c.charCodeAt(0));
			return new TextDecoder('utf-8').decode(bytes);
		}

		let apiKey = ""
		fetch('/jiapu/ali_LLM_apikey_encoded.txt')
			.then(response => response.text())
			.then(content => { 
				const baseDecoded = base64DecodeUnicode(content)
				apiKey = baseDecoded.split("").reverse().join("")
				});	
		
		let familyData = ""
		fetch('/jiapu/familyData.encoded.txt')
			.then(response => response.text())
			.then(content => { 
				const baseDecoded = base64DecodeUnicode(content)
				familyData = baseDecoded.split("").reverse().join("")
				});	
				
	    async function streamQwenResponse(msg, selectedMode) {
            let apiUrl  = ""
            if (selectedMode === "chat-wsk") { 
                apiUrl = "/jiapu/chat-wsk"
                messages = msg.slice(1)
            
            }
            else{
                apiUrl = "https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions"
                messages = msg
            }

 
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`,
                        'X-DashScope-SSE': 'enable' // 启用服务器发送事件(SSE)
                    },
                    
                    body: JSON.stringify({
                        model: "qwen-plus",  // 添加模型参数
                        messages: messages,
                        stream: true
                    })
                });

                if (!response.ok) {
                    throw new Error(`API请求失败: ${response.status}`);
                }

                // 根据调用的API不同，采用不同的处理方式
                 // 处理从Flask后端返回的流式响应
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        buffer += decoder.decode(value, { stream: true });
                        
                        // 处理可能的多条消息
                        const lines = buffer.split('\n');
                        buffer = lines.pop(); // 最后一行可能不完整，保留在buffer中
                        
                        for (const line of lines) {
                            if (line.startsWith('data:') && line !== 'data: [DONE]') {
                                try {
                                    const data = JSON.parse(line.substring(5));
                                    if (data.choices && data.choices[0].delta && data.choices[0].delta.content) {
                                        appendToAiMessage(data.choices[0].delta.content);
                                    }
                                } catch (e) {
                                    console.error('解析SSE数据错误:', e);
                                }
                        }

                    }
                        
                    }
                    
                    // 处理buffer中剩余的内容
                    if (buffer.trim() !== '') {
                        appendToAiMessage(buffer);
                    }
            }catch(e){
                console.error('解析SSE数据错误:', e);
            }
        } // 闭合streamQwenResponse函数
		
 
        sendChatBtn.addEventListener('click', async () => {		
            const userQuery = chatInput.value.trim();
            // 修改: 当输入为空时使用 placeholder 内容
            const finalQuery = userQuery || chatInput.placeholder.trim();
            if (!finalQuery) return;

            // 添加用户消息
            addMessageToChat(finalQuery, 'user');
            chatInput.value = '';
            chatHistory.push({ role: "user", content: finalQuery });

            // 获取选中的单选按钮的值
            const selectedMode = document.querySelector('input[name="chatMode"]:checked').value;
            console.log("选中的模式:", selectedMode);

            // 创建AI消息元素并初始化
            currentAiMessageElement = addMessageToChat('思考中...', 'ai');
            currentAiMessageContent = '';

            sendChatBtn.disabled = true;
            const originalButtonContent = sendChatBtn.innerHTML;
            sendChatBtn.innerHTML = `思考中<span class="loading-dot"></span><span class="loading-dot"></span><span class="loading-dot"></span>`;

            try {
				const systemInstruction = `
					现在时间是:${getCurrentChineseDateTime()}. 
					你是一个家族谱系专家，
					你的任务是根据提供的家族信息，
					回答用户关于家族成员的提问。
					请只回答基于你所提供的信息，
					不要编造。
					如果信息不在你提供的内容中，
					请说明你无法找到相关信息。
					请以简洁、直接的中文回答。
					然后以适当语气或者给予一定的评论,
					比如查到某人是个大学学习,
					要适当赞扬几句有才聪明爱学习之类的话语,
					又或者对于活得久的你就说他养生有方得了个长寿,
					早早就过世的就给予一定的惋惜,
					并提醒大家要注意身体健康,等等之类的评论。
					
					请使用Markdown格式回复，包含标题、列表和强调文本。
					
					下面是提供给你检索信息的杨氏族谱书的内容:

				`;				
			
				// 构造消息数组
				const messages = [
					{ role: "system", content: systemInstruction + "\n\n" + familyData },
					...chatHistory.map(msg => ({ role: msg.role, content: msg.content }))
				];
									
				// 开始流式请求
				await streamQwenResponse(messages, selectedMode);

				// 将完整的AI响应添加到聊天历史
				chatHistory.push({ role: "assistant", content: currentAiMessageContent });
				
            } catch (error) {
                console.error('处理请求时出错:', error);
                appendToAiMessage('\n\n[发生错误，请重试]');
            }finally {                
                sendChatBtn.disabled = false;
                sendChatBtn.innerHTML = originalButtonContent;
                currentAiMessageElement = null;
                currentAiMessageContent = '';
            }
        });

        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !sendChatBtn.disabled) {
                sendChatBtn.click();
            }
        });
    </script>
</body>
</html>